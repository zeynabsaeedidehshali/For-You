<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>For You</title>
<style>
  :root{
    --rose:#ffd1e6; --orchid:#f3c0ff; --lilac:#e7c6ff;
    --ink1:#4d0f3f; --ink2:#6c2a5e; --ink3:#5b1c51;
    --glass: rgba(255,255,255,.78); --glass-border: rgba(255,255,255,.9);
    --shadow: 0 16px 44px rgba(91,28,81,.16), 0 3px 12px rgba(91,28,81,.10);
    --glow1: rgba(255, 170, 232, .9);
    --bw-bg1:#f2f2f2; --bw-bg2:#e5e5e5; --bw-ink:#2a2a2a; --bw-mid:#d9d9d9; --bw-light:#fafafa;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; touch-action: manipulation; overflow:hidden;
    -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji", emoji, sans-serif;
    background: linear-gradient(180deg, var(--bw-bg1), var(--bw-bg2));
    color: var(--bw-ink);
  }

  /* ---------------- Envelope Scene (no overlap, mobile-safe) ---------------- */
  .envelope-scene{
    position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap: 18px; padding: 18px 14px 28px;
    background:
      linear-gradient(180deg, var(--bw-bg1), var(--bw-bg2));
    z-index: 30;
    transition: opacity .9s ease, transform .9s ease;
    filter: grayscale(1) contrast(0.9) brightness(0.97);
  }
  .env-stack{ display:flex; flex-direction:column; align-items:center; gap:14px; width:100%; max-width:min(92vw,560px); }

  .envelope-wrap{
    position:relative; width:100%; aspect-ratio: 4/3;
    perspective: 1200px; /* important for stable 3D on mobile */
    filter: drop-shadow(0 10px 22px rgba(0,0,0,.2));
  }
  .envelope{
    position:absolute; inset:0; border-radius: 16px; overflow:hidden;
    background: linear-gradient(180deg, var(--bw-light), var(--bw-mid));
    box-shadow:
      0 2px 0 rgba(255,255,255,.8) inset,
      0 -2px 0 rgba(0,0,0,.04) inset,
      0 10px 24px rgba(0,0,0,.16), 0 2px 8px rgba(0,0,0,.08);
    transform-style: preserve-3d;
  }

  /* Inner pocket graphic */
  .pocket{
    position:absolute; inset:auto 0 0 0; height:55%;
    background:
      linear-gradient(180deg, #ececec, #d6d6d6);
    clip-path: polygon(0 0, 100% 0, 85% 100%, 15% 100%);
    box-shadow: 0 -1px 0 rgba(255,255,255,.7) inset;
  }

  .flap{
    position:absolute; left:0; right:0; top:0; height:58%;
    transform-origin: top center;
    background: linear-gradient(180deg, #e5e5e5, #c9c9c9);
    clip-path: polygon(0 0, 100% 0, 50% 100%);
    border-top-left-radius: 16px; border-top-right-radius: 16px;
    box-shadow: 0 1px 0 rgba(255,255,255,.85) inset, 0 -2px 0 rgba(0,0,0,.05) inset;
    backface-visibility: hidden; /* prevent flicker on iOS */
    transform: rotateX(0deg);
    transition: transform .8s cubic-bezier(.22,1,.27,1);
  }

  /* Paper letter, subtle grain */
  .letter{
    position:absolute; left:7%; right:7%; top:18%; bottom:9%;
    background:
      linear-gradient(180deg, #fff, #f7f7f7),
      repeating-linear-gradient(90deg, rgba(0,0,0,.015) 0 1px, rgba(0,0,0,0) 1px 3px);
    border-radius: 12px;
    box-shadow: 0 2px 0 rgba(0,0,0,.05) inset, 0 8px 20px rgba(0,0,0,.06);
    display:flex; align-items:center; justify-content:center; text-align:center;
    color:#333; padding:18px; line-height:1.35; font-size: clamp(16px, 3.6vw, 18px);
  }

  /* Wax seal (grayscale, little pulse) */
  .seal{
    position:absolute; left:50%; top:38%; transform:translate(-50%,-50%) translateZ(1px);
    width: clamp(54px, 14vw, 74px); aspect-ratio:1/1; border-radius:50%;
    background: radial-gradient(circle at 42% 34%, #eee, #bdbdbd 58%, #8c8c8c);
    color:#fff; display:grid; place-items:center; font-size: clamp(22px, 6vw, 28px);
    box-shadow: 0 6px 16px rgba(0,0,0,.18), inset 0 2px 10px rgba(255,255,255,.45);
    animation: sealPulse 2.2s ease-in-out infinite;
    backface-visibility: hidden;
  }
  .seal::after{ content:"‚úâÔ∏è"; filter: grayscale(1); }
  @keyframes sealPulse{ 50%{ transform:translate(-50%,-50%) translateZ(1px) scale(1.04) } }

  /* Open button is below envelope, never overlaps */
  .cta{
    position:relative;
    background:#2a2a2a; color:#fff; border:none; border-radius:10px;
    padding: 12px 18px; font-size: clamp(14px, 3.8vw, 16px);
    letter-spacing:.3px; cursor:pointer;
    box-shadow: 0 8px 20px rgba(0,0,0,.18);
    transition: transform .2s ease, box-shadow .2s ease;
  }
  .cta:active{ transform: scale(.97); box-shadow: 0 6px 16px rgba(0,0,0,.18); }

  /* Scene transitions */
  body.opening .flap{ transform: rotateX(168deg); }
  body.opening .envelope-scene{ transform: translateY(2px) }
  body.opened .envelope-scene{ opacity:0; transform: translateY(6px); pointer-events:none; }

  /* Cinematic reveal overlay (lighter for perf) */
  .sweep{
    position:fixed; inset:0; z-index:25; pointer-events:none; opacity:0;
    background: radial-gradient(800px 580px at 50% 50%, rgba(255,255,255,.8), rgba(255,255,255,0) 60%);
    filter: blur(10px) saturate(1.15);
    transition: opacity .6s ease;
  }
  body.opened .sweep{ opacity:1; animation: sweepMove 1.2s ease-out forwards; }
  @keyframes sweepMove{
    0%{ transform: translateY(16px) scale(1.01); opacity:.3 }
    70%{ transform: translateY(-8px); opacity:.9 }
    100%{ transform: translateY(0); opacity:0 }
  }

  /* ---------------- Party Scene ---------------- */
  .party-root{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    opacity:0; transform: translateY(8px) scale(.985);
    transition: opacity .8s ease .1s, transform .8s ease .1s;
    background:
      radial-gradient(1200px 800px at 10% -10%, rgba(255,182,222,.32), transparent 60%),
      radial-gradient(1000px 700px at 110% 120%, rgba(237,200,255,.32), transparent 60%),
      linear-gradient(180deg, var(--rose), var(--orchid) 50%, var(--lilac));
  }
  body.opened .party-root{ opacity:1; transform: translateY(0) scale(1); }

  canvas.bg-layer{ position:fixed; inset:0; pointer-events:none; z-index:0; opacity:0; transition: opacity .7s ease .25s; }
  body.opened canvas.bg-layer{ opacity:1; }

  /* Layout blocks (no overlap) */
  .content{
    position:relative; z-index:2; display:flex; flex-direction:column; align-items:center;
    width:min(1000px, 96vw); margin:auto; padding: clamp(10px, 3vw, 18px);
    gap: clamp(12px, 4vw, 24px);
  }
  .hero-heart{ display:flex; align-items:center; justify-content:center; width:100%; margin-top: clamp(6px, 4vw, 14px); }
  .heart-wrap{
    position:relative; display:grid; place-items:center; width: clamp(100px, 22vw, 170px); aspect-ratio:1/1;
    cursor:pointer; user-select:none; filter: drop-shadow(0 12px 30px rgba(183,108,255,.42));
    margin-bottom: clamp(6px, 3vw, 16px);
  }
  #heartBtn{ font-size: clamp(70px,17.5vw,160px); line-height:1; transform: translateZ(0) scale(1); animation: beat 1.05s ease-in-out infinite; }
  @keyframes beat{ 0%,100%{transform:scale(1)} 14%{transform:scale(1.12)} 28%{transform:scale(1)} 42%{transform:scale(1.08)} 70%{transform:scale(1)} }

  .heart-wrap::before{
    content:""; position:absolute; inset:-18%; border-radius:50%;
    background: radial-gradient(circle at 50% 50%, var(--glow1) 0%, rgba(255,255,255,.75) 22%, transparent 62%);
    filter: blur(16px); animation: halo 1.8s ease-in-out infinite;
  }
  @keyframes halo{ 0%,100%{ transform: scale(1); opacity:.95 } 50%{ transform: scale(1.04); opacity:1 } }

  .orbit{
    position:absolute; inset:-8%; border-radius:50%; pointer-events:none;
    background:
      radial-gradient(4px 4px at 12% 48%, rgba(255,255,255,.95), transparent 60%),
      radial-gradient(3px 3px at 74% 22%, rgba(255,255,255,.9), transparent 60%);
    filter: drop-shadow(0 0 12px rgba(255,255,255,.85));
    animation: orbit 2.6s linear infinite;
    mix-blend-mode: screen;
  }
  @keyframes orbit{ to{ transform: rotate(360deg) } }

  
.text-box{
  position: relative;
  overflow: hidden;
  background: linear-gradient(180deg, var(--glass), rgba(255,255,255,.64));
  -webkit-backdrop-filter: blur(7px); backdrop-filter: blur(7px);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  box-shadow: var(--shadow), 0 0 0 1px rgba(255,255,255,.6) inset, 0 18px 50px rgba(183,108,255,.18);
  padding: clamp(18px, 5vw, 32px);
  text-align:center;
  max-width: 820px;
  margin: 0 auto;
}
/* Fairytale glitter overlay (stars + shimmer) */
.text-box::before{
  content:"";
  position:absolute; inset:-4px;
  border-radius: inherit;
  pointer-events:none;
  background:
    linear-gradient(115deg, transparent 45%, rgba(255,255,255,.55) 50%, transparent 55%),
    radial-gradient(3px 3px at 18% 22%, rgba(255,255,255,.9), transparent 60%),
    radial-gradient(2.6px 2.6px at 62% 18%, rgba(255,255,255,.85), transparent 60%),
    radial-gradient(2.8px 2.8px at 82% 66%, rgba(255,255,255,.9), transparent 60%),
    radial-gradient(2px 2px at 32% 74%, rgba(255,255,255,.85), transparent 60%),
    radial-gradient(2px 2px at 12% 84%, rgba(255,255,255,.85), transparent 60%);
  mix-blend-mode: screen;
  animation: shimmer 3.2s linear infinite, twinkle 1.8s steps(1,end) infinite;
  opacity:.9;
 z-index:2;
}
/* Animated prismatic border */
.text-box::after{
  content:"";
  position:absolute; inset:-3px;
  border-radius: inherit;
  background: conic-gradient(from 0deg, #ffd6ea, #ffffff, #f0d4ff, #ffd6ea);
  padding:3px;
  -webkit-mask:
    linear-gradient(#000 0 0) content-box,
    linear-gradient(#000 0 0);
  -webkit-mask-composite: xor;
          mask-composite: exclude;
  
  pointer-events:none;
  box-shadow: 0 0 20px rgba(255, 170, 232, .25);
 z-index:1; opacity:.85;
}
@keyframes shimmer{
  0%{ background-position: -200% 0, 0 0, 0 0, 0 0, 0 0, 0 0; }
  100%{ background-position: 200% 0, 0 0, 0 0, 0 0, 0 0, 0 0; }
}
@keyframes twinkle{
  0%, 100%{ opacity:.88; }
  50%{ opacity:1; }
}
 }
@media (prefers-reduced-motion: reduce){
  .text-box::before, .text-box::after{ animation: none !important;  z-index:1; opacity:.85;
}
}

  
h1{
  font-size: clamp(36px,7.6vw,84px); margin:0;
  color:#4d0f3f; /* high-contrast deep rose */
  font-weight: 800;
  text-shadow: 0 1.5px 0 rgba(0,0,0,.06), 0 10px 22px rgba(77,15,63,.18);
  letter-spacing: .6px;
}

  #moreText{
    white-space: pre-line; font-size: clamp(18px,4.6vw,26px); color: var(--ink3);
    opacity:0; transform: translateY(10px) scale(0.99);
    transition: opacity .6s ease, transform .6s cubic-bezier(.17,.84,.44,1);
    margin-top: 12px;
  }
  #moreText.show{ opacity:1; transform: translateY(0) scale(1); }

  /* Reduce motion for users who prefer it */
  @media (prefers-reduced-motion: reduce){
    .flap, .heart-wrap::before, .orbit, #heartBtn, .sweep{ animation: none !important; transition: none !important; }
  }

/* --- Fairytale spark pops on the message box --- */
.text-box .sparks{
  position:absolute; inset:0; pointer-events:none; z-index:5;
}

.text-box .spark{
  position:absolute; width:10px; height:10px;
  left:50%; top:50%; transform: translate(-50%,-50%) scale(0.25);
  border-radius:50%;
  background: radial-gradient(circle, rgba(255,255,255,1) 0 45%, rgba(255,255,255,0) 72%);
  filter: drop-shadow(0 0 10px rgba(255,255,255,.98)) drop-shadow(0 0 16px rgba(255,210,255,.70));
  opacity:0;
  animation: sparkPop 1000ms ease-out forwards;
}


.text-box .spark::before,
.text-box .spark::after { width:2px; height:26px; opacity:1; }

.text-box .spark::before{ width:26px; height:2px; opacity:1; }
.text-box .spark::after { width:2px; height:26px; opacity:1; }

@keyframes sparkPop{
  0%  { opacity:0; transform: translate(-50%,-50%) scale(0.2); }
  30% { opacity:1; transform: translate(-50%,-50%) scale(1); }
  70% { opacity:1; transform: translate(-50%,-50%) scale(1); }
  100%{ opacity:0; transform: translate(-50%,-50%) scale(0.2); }
}

@media (prefers-reduced-motion: reduce){
  
.text-box .spark{
  position:absolute; width:10px; height:10px;
  left:50%; top:50%; transform: translate(-50%,-50%) scale(0.25);
  border-radius:50%;
  background: radial-gradient(circle, rgba(255,255,255,1) 0 45%, rgba(255,255,255,0) 72%);
  filter: drop-shadow(0 0 10px rgba(255,255,255,.98)) drop-shadow(0 0 16px rgba(255,210,255,.70));
  opacity:0;
  animation: sparkPop 1000ms ease-out forwards;
}

}

</style>
</head>
<body>
  <!-- Envelope Scene -->
  <div class="envelope-scene" id="envelopeScene" aria-live="polite">
    <div class="env-stack">
      <div class="envelope-wrap">
        <div class="envelope">
          <div class="pocket"></div>
          <div class="flap" id="flap"></div>
          <div class="letter">
            <div>
              <div style="font-weight:700; font-size:clamp(18px,4.6vw,20px); color:#333;">A letter for you</div>
              
            </div>
          </div>
          <div class="seal"></div>
        </div>
      </div>
      <button class="cta" id="openBtn" aria-label="Open the envelope">Open</button>
    </div>
  </div>

  <!-- Cinematic reveal overlay -->
  <div class="sweep"></div>

  <!-- Party Scene -->
  <div class="party-root">
    <canvas id="bg" class="bg-layer"></canvas>
    <canvas id="confetti" class="bg-layer"></canvas>

    <div class="content" aria-live="polite">
      <div class="hero-heart">
        <div class="heart-wrap" id="heartWrap" aria-label="Heart">
          <div class="orbit" aria-hidden="true"></div>
          <div id="heartBtn">üíñ</div>
        </div>
      </div>

      <div class="text-box">
        <div class="sparks" id="sparks" aria-hidden="true"></div>
        <h1 id="headline">Happy Birthday My Love</h1>
        <div id="moreText">My heart beats happiest with you üíï
I love you more than all the stars ‚ú®, all the songs üé∂, and every heartbeat ‚ù§Ô∏è. Happy Birthday, my forever. üíïüíúüíòüòò</div>
      </div>
    </div>
  </div>

<script>
/* Envelope open */
const openBtn = document.getElementById('openBtn');
const flap = document.getElementById('flap');
const envelopeScene = document.getElementById('envelopeScene');
let opened = false, rafStarted = false;
function openEnvelope(){
  if(opened) return; opened = true;
  document.body.classList.add('opening');
  flap.style.transform = 'rotateX(168deg)'; // gentler angle to avoid 3D tearing
  setTimeout(()=>{
    document.body.classList.remove('opening'); document.body.classList.add('opened');
    if(!rafStarted){ rafStarted = true; startParty(); setTimeout(()=> popAt(innerWidth/2, innerHeight/1.18, 1.0), 500); }
  }, 420);
}
openBtn.addEventListener('click', openEnvelope, {passive:true});
envelopeScene.addEventListener('click', (e)=>{
  // Click anywhere on envelope stack also opens; button stays separate to avoid overlap
  if(e.target.id === 'openBtn') return;
  if(!e.target.closest('.envelope-wrap')) return;
  openEnvelope();
}, {passive:true});

/* Renderer perf tuning */
const ua = navigator.userAgent;
const isIOS = /iP(hone|ad|od)/i.test(ua);
const isAndroid = /Android/i.test(ua);
const isMobile = isIOS || isAndroid;
/* Lower DPR caps for smoothness on phones */
const DPR_CAP = isIOS ? 0.8 : 1.0;
const DPR = Math.min(DPR_CAP, window.devicePixelRatio || 1);
/* Lower counts for mobile */
let SPRITE_COUNT = isMobile ? 26 : 70;
let MAX_PIECES   = isMobile ? 160 : 320;

let running = true;
document.addEventListener('visibilitychange', () => { running = !document.hidden; });

// Emojis (pink/lilac + stars/moon/clouds + kisses)
const EMOJIS = ["üíñ","üíó","üíú","‚ú®","üåü","‚≠ê","üåô","‚òÅÔ∏è","‚òÅÔ∏è","üòò","üòö","üíã","‚ú®","üíñ","üíó"];

const glyphCache = new Map();
const CACHE_LIMIT = 72;
function makeEmojiCanvas(char, size){
  const c = document.createElement('canvas');
  const pad = Math.ceil(size*0.30);
  c.width = c.height = (size + pad*2);
  const g = c.getContext('2d', { willReadFrequently: false });
  g.textAlign = 'center'; g.textBaseline = 'middle';
  g.font = size + 'px "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",emoji, serif';
  g.fillText(char, c.width/2, c.height/2);
  return c;
}
function getGlyph(char, size){
  const key = char + '@' + Math.round(size);
  if(!glyphCache.has(key)){
    if(glyphCache.size > CACHE_LIMIT){
      const firstKey = glyphCache.keys().next().value;
      glyphCache.delete(firstKey);
    }
    glyphCache.set(key, makeEmojiCanvas(char, Math.round(size)));
  }
  return glyphCache.get(key);
}

let bg, ctx, conf, c2, W=0,H=0,cx=0,cy=0, W2=0,H2=0;
let sprites=[], pieces=[];

function setupCanvases(){
  bg = document.getElementById('bg');
  ctx = bg.getContext('2d', { alpha:true });
  conf = document.getElementById('confetti');
  c2 = conf.getContext('2d', { alpha:true });

  function resizeAll(){
    let w = innerWidth, h = innerHeight;
    for(const c of [bg, conf]){
      c.style.width = w + 'px'; c.style.height = h + 'px';
      c.width = Math.floor(w * DPR); c.height = Math.floor(h * DPR);
    }
    ctx.setTransform(DPR,0,0,DPR,0,0);
    c2.setTransform(DPR,0,0,DPR,0,0);
    W=w; H=h; cx=W/2; cy=H/2; W2=w; H2=h;
  }
  resizeAll();
  addEventListener('resize', resizeAll, {passive:true});
}

function resetSprite(s){
  s.angle=Math.random()*Math.PI*2;
  s.radius=0.35+Math.random()*1;
  s.z=1+Math.random()*3.2;
  s.char=EMOJIS[(Math.random()*EMOJIS.length)|0];
  s.size=(isMobile?18:18)+Math.random()*22;
  s.spin=(Math.random()<.5?-1:1)*(0.0008+Math.random()*0.0022);
  s.speed=(isMobile?0.010:0.009)+Math.random()*0.013;
  return s;
}
function initSprites(){
  sprites.length = 0;
  for(let i=0;i<SPRITE_COUNT;i++){ sprites.push(resetSprite({})); }
}

function loopBG(){
  if(!running){ requestAnimationFrame(loopBG); return; }
  ctx.clearRect(0,0,W,H);
  for(const s of sprites){
    s.angle+=s.spin; s.z-=s.speed;
    if(s.z<=0.05) resetSprite(s), s.z=3.2;
    const tubeR=Math.min(W,H)*0.44;
    const k=tubeR*s.radius/s.z;
    const x=cx+Math.cos(s.angle)*k;
    const y=cy+Math.sin(s.angle)*k;
    const size=s.size*(1.4/s.z);
    const glyph = getGlyph(s.char, size);
    ctx.drawImage(glyph, x - glyph.width/2, y - glyph.height/2);
  }
  requestAnimationFrame(loopBG);
}

function addConfetti(n=70, origin={x:innerWidth/2,y:innerHeight/2}){
  const count = isMobile ? Math.floor(n*0.65) : n;
  for(let i=0;i<count;i++){
    const char = EMOJIS[(Math.random()*EMOJIS.length)|0];
    pieces.push({x:origin.x,y:origin.y,
      vx:(Math.random()*2-1)*5.2, vy:(Math.random()*-1-1)*6.0,
      g:0.17+Math.random()*0.08, char,
      size:(isMobile?18:20)+Math.random()*20,
      life:(isMobile?110:150)+Math.random()*100
    });
  }
  if(pieces.length > MAX_PIECES) pieces.splice(0, pieces.length - MAX_PIECES);
}

function loopConfetti(){
  if(!running){ requestAnimationFrame(loopConfetti); return; }
  c2.clearRect(0,0,W2,H2);
  pieces=pieces.filter(p=>(p.life-=1)>0 && p.y<H2+40);
  for(const p of pieces){
    p.vy+=p.g; p.x+=p.vx; p.y+=p.vy;
    const glyph = getGlyph(p.char, p.size);
    c2.drawImage(glyph, p.x - glyph.width/2, p.y - glyph.height/2);
  }
  requestAnimationFrame(loopConfetti);
}

/* Interactions */
const heartWrap = document.getElementById('heartWrap');
const moreText = document.getElementById('moreText');
function heartCenter(){ const rect = heartWrap.getBoundingClientRect(); return { x: rect.left + rect.width/2, y: rect.top + rect.height/2 }; }
function popAt(x,y,scale=1){ addConfetti(Math.round((isMobile?50:70)*scale), {x,y}); }
function sparkleBurst(x,y){
  const n = 10;
  for(let i=0;i<n;i++){
    const s = document.createElement('div'); s.className='spark';
    s.style.position='fixed'; s.style.width='6px'; s.style.height='6px';
    s.style.background='radial-gradient(circle, #fff 0 35%, rgba(255,255,255,0) 70%)';
    s.style.borderRadius='50%'; s.style.pointerEvents='none'; s.style.zIndex='3';
    s.style.filter='drop-shadow(0 0 10px #fff)';
    const a = Math.random()*Math.PI*2, r = 8 + Math.random()*24;
    s.style.left = (x + Math.cos(a)*4) + 'px'; s.style.top  = (y + Math.sin(a)*4) + 'px';
    document.body.appendChild(s);
    const dx = Math.cos(a)*r, dy = Math.sin(a)*r, life = 520 + Math.random()*300;
    const start = performance.now();
    (function anim(t){
      const k = Math.min(1, (t-start)/life);
      s.style.transform = `translate(${dx*k}px, ${dy*k}px) scale(${1-k*0.6})`; s.style.opacity = (1-k).toFixed(2);
      if(k<1) requestAnimationFrame(anim); else s.remove();
    })(start);
  }
}

function bindPartyEvents(){
  // Click on heart: reveal text + big pop
  heartWrap.addEventListener('click',()=>{
    const rect = heartWrap.getBoundingClientRect();
    const x = rect.left + rect.width/2, y = rect.top + rect.height/2;
    sparkleBurst(x, y);
    popAt(innerWidth/2, innerHeight/2.05, 2.2);
    moreText.classList.add('show');
  }, {passive:true});

  // Taps/clicks elsewhere: small confetti pop
  document.addEventListener('click',e=>{ if(heartWrap.contains(e.target)) return; popAt(e.clientX, e.clientY, 1); }, {passive:true});

  if ('PointerEvent' in window){
    // Pointer events path (modern phones & browsers)
    let touching=false, lastPop=0;
    document.addEventListener('pointerdown', e=>{
      touching=true;
      sparkleBurst(e.clientX, e.clientY);
      popAt(e.clientX, e.clientY, 1.1);
    }, {passive:true});
    document.addEventListener('pointermove', e=>{
      if(!touching) return;
      const now = performance.now();
      if(now - lastPop > 70){
        lastPop = now;
        popAt(e.clientX, e.clientY, 0.5);
      }
    }, {passive:true});
    document.addEventListener('pointerup', ()=>{ touching=false; }, {passive:true});
    document.addEventListener('pointercancel', ()=>{ touching=false; }, {passive:true});
  } else {
    // Touch events fallback (older mobile Safari/Android WebView)
    let touching=false, lastPop=0;
    function tp(e){
      const t = (e.touches && e.touches[0]) || (e.changedTouches && e.changedTouches[0]);
      return t ? {x:t.clientX, y:t.clientY} : {x:innerWidth/2, y:innerHeight/2};
    }
    document.addEventListener('touchstart', e=>{
      touching=true;
      const {x,y} = tp(e);
      sparkleBurst(x,y);
      popAt(x,y,1.1);
    }, {passive:true});
    document.addEventListener('touchmove', e=>{
      if(!touching) return;
      const now = performance.now();
      if(now - lastPop > 70){
        lastPop = now;
        const {x,y} = tp(e);
        popAt(x,y,0.5);
      }
    }, {passive:true});
    document.addEventListener('touchend', ()=>{ touching=false; }, {passive:true});
    document.addEventListener('touchcancel', ()=>{ touching=false; }, {passive:true});
  }
}


/* Start renderers after envelope opens */

/* Spark generator on the message box */
function startSparks(){
  // initial sparkle
  setTimeout(()=>{ const layer=document.getElementById('sparks'); if(layer){ const s=document.createElement('div'); s.className='spark'; s.style.left='50%'; s.style.top='40%'; layer.appendChild(s); setTimeout(()=>s.remove(), 1000);} }, 250);

  const box = document.querySelector('.text-box');
  const layer = document.getElementById('sparks');
  if(!box || !layer) return;

  const isReduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const maxSparks = isMobile ? 12 : 16;
  let active = 0;

  function spawn(){
    if(active >= maxSparks) return;
    const rect = box.getBoundingClientRect();
    // Keep sparks within inner area (avoid edges/padding)
    const padX = Math.min(24, rect.width * 0.06);
    const padY = Math.min(18, rect.height * 0.08);
    const x = Math.random() * (rect.width - padX*2) + padX;
    const y = Math.random() * (rect.height - padY*2) + padY;

    const s = document.createElement('div');
    s.className = 'spark';
    s.style.left = x + 'px';
    s.style.top  = y + 'px';
    layer.appendChild(s);
    active++;

    const life = isReduce ? 0 : 900;
    setTimeout(()=>{ s.remove(); active--; }, life || 0);
  }

  // Ambient interval (slightly randomized cadence)
  let base = isMobile ? 420 : 360;
  const timer = setInterval(()=>{
    // Occasionally spawn 2 at once for a little flare
    spawn();
    if(Math.random() < 0.28) spawn();
  }, base + Math.random()*220);

  // Also spark on heart click reveal for extra delight
  const heart = document.getElementById('heartWrap');
  if(heart){
    heart.addEventListener('click', ()=>{
      for(let i=0;i<4;i++) setTimeout(spawn, i*90);
    }, {passive:true});
  }

  // Clean up if visibility changes (battery friendly)
  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden){ clearInterval(timer); }
  }, {once:true});
}

function startParty(){
  setupCanvases();
  initSprites();
  requestAnimationFrame(loopBG);
  requestAnimationFrame(loopConfetti);
  bindPartyEvents();
startSparks(); }

/* Minor fix for iOS momentum scroll repaint */
document.addEventListener('touchmove', ()=>{}, {passive:true});
</script>
</body>
</html>
